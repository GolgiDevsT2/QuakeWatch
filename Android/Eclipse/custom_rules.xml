<?xml version="1.0" encoding="UTF-8"?>
<project name="custom_rules" basedir=".">
	
	<property name="src.dir"   location="src" />
    <property name="build.dir" location="bin" />
    <property name="dist.dir"  location="dist" />
    <property name="docs.dir"  location="docs" />
    
    <property name="srcThriftFile"      location="../../QuakeWatch.thrift" />
    <property name="srcGolgiDevKeyFile" location="../../Golgi.DevKey" />
    <property name="srcGolgiAppKeyFile" location="../../Golgi.AppKey" />
    <property name="garrickCombinedFile" location="${user.home}/Golgi-Pkg/LATEST/common/garrick_combined.jar"/>
    
    <fail message="FILE NOT FOUND: ${srcThriftFile}">
	    <condition>
	        <not>
	        	<available file="${srcThriftFile}" />
	    	</not>	
	    </condition>
	</fail>
	
	<fail message="FILE NOT FOUND: ${srcGolgiAppKeyFile}">
	    <condition>
	        <not>
	        	<available file="${srcGolgiAppKeyFile}" />
	    	</not>	
	    </condition>
	</fail>
	
	<fail message="FILE NOT FOUND: ${srcGolgiDevKeyFile}">
	    <condition>
	        <not>
	        	<available file="${srcGolgiDevKeyFile}" />
	    	</not>	
	    </condition>
	</fail>
	    
    <target name="makeGolgiDir" >

        <mkdir dir="${build.dir}" />
        <mkdir dir="${docs.dir}" />
        <mkdir dir="${dist.dir}" />

        <loadfile property="file" srcfile="${srcThriftFile}" >

            <filterchain>
                <headfilter lines="1" skip="0" />
                <tokenfilter>
                    <replaceregex flags="gi" pattern=".* \\*" replace="" />
                </tokenfilter>
                <striplinebreaks />
            </filterchain>
        </loadfile>

        <macrodef name="trim" >
            <attribute name="${file}" />
            <sequential>

                <propertyregex
                    defaultvalue="${@{file}}"
                    input="${@{file}}"
                    override="true"
                    property="@{file}"
                    regexp="[\s]*(.+)[\s]*"
                    replace="\1" />

            </sequential>
        </macrodef>

        <property
            name="propTmp"
            value="${file}" />

        <script language="javascript" >
			project.setProperty('packageForGolgiGen', project.getProperty('propTmp').
			replace(".", "/"));
        </script>

        <mkdir dir="${src.dir}/${packageForGolgiGen}" />

        <touch file="${src.dir}/${packageForGolgiGen}/GolgiKeys.java" />

        <loadresource property="DevKey" >

            <file file="${srcGolgiDevKeyFile}" />
        </loadresource>

        <loadresource property="AppKey" >

            <file file="${srcGolgiAppKeyFile}" />
        </loadresource>

        <echo
            append="false"
            file="${src.dir}/${packageForGolgiGen}/GolgiKeys.java" >
/* IS_AUTOGENERATED_SO_ALLOW_AUTODELETE=YES */
/* The previous line is to allow auto deletion */
package ${file};
public class GolgiKeys {
	public static final String DEV_KEY = "${DevKey}";
	public static final String APP_KEY = "${AppKey}";
}
        </echo>

        <java classname="com.openmindnetworks.golgi.garrick.Garrick" >

            <arg line="-i ${srcThriftFile} -jo ${src.dir}/${packageForGolgiGen}" />

            <classpath>
                <pathelement location="${garrickCombinedFile}" />
            </classpath>
        </java>
    </target>
    
    <target name="cleanGolgi">
        <delete dir="${build.dir}" />
		<delete dir="${docs.dir}" />
		<delete dir="${dist.dir}" />
		
		<loadfile property="file" srcfile="${srcThriftFile}" >
			<filterchain>
				<headfilter lines="1" skip="0" />
				<tokenfilter>
					<replaceregex flags="gi" pattern=".* \\*" replace="" />
				</tokenfilter>
				<striplinebreaks />
			</filterchain>
		</loadfile>
		
		<macrodef name="trim" >
			<attribute name="${file}" />
			<sequential>
				<propertyregex
					      defaultvalue="${@{file}}"
					      input="${@{file}}"
					      override="true"
					      property="@{file}"
					      regexp="[\s]*(.+)[\s]*"
					      replace="\1" />
			</sequential>
		</macrodef>
		
		<property name="propTmp" value="${file}" />
		
		<script language="javascript" >
			project.setProperty('packageForGolgiGen', project.getProperty('propTmp').
			replace(".", "/"));
		</script>
		
		<delete dir="${src.dir}/${packageForGolgiGen}" />
        
    </target>
</project>